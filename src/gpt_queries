import time
import openai
import os
from dotenv import load_dotenv
from getEmbeddings import get_embeddings
load_dotenv()

openai.api_type = "azure"
openai.api_key = os.getenv('OPENAI_API_KEY')
openai.api_base = "https://tu-openai-api-management.azure-api.net/OLTATKULL"
openai.api_version = "2023-07-01-preview"

demo_queries = ""


def process_query(query, data):
    assert isinstance(query, str), "`query` should be a string"
    system_content_message = demo_queries.append(data)
    try:
        response = openai.ChatCompletion.create(
            deployment_id="IDS2023_PIKANI_GPT35",
            model="gpt-3.5-turbo",
            temperature=0.0,  # Setting the temperature
            messages=[{"role": "system", "content": system_content_message},
                      {"role": "user", "content": query}]
        )
        status_code = response["choices"][0]["finish_reason"]
        assert status_code == "stop", f"The status code was {status_code}."
        return response["choices"][0]["message"]["content"]
    except Exception as e:
        print("An error occurred:", e)


def get_k_recommendations(query, k=5):
    assert isinstance(query, str), "`query` should be a string"
    assert isinstance(k, int), "`k` should be an integer"
    assert k > 0, "`k` should be greater than 0"
    query_embedding, tokens_used = get_embeddings(query)
    if query_embedding is None:
        return None
    else:
        pass
        # TODO cosine similarity function
        # TODO get k recommendations
        # TODO return k recommendations


i = 0
print("------------COURSE RECOMMENDER----------------")
print("")
print("Hello! How may I help you?")
print("")
query = input("Question: ")
while query != "exit":
    i += 1
    answer = "Here are my top 5 recommendations:"
    # top_k = get_k_recommendations(query)
    # answer = process_query(query, top_k)
    print("")
    print(f"Answer: ")
    print("")
    print(answer)
    print("")
    time.sleep(1)
    print(f"[{i}] -----------------------------------------")
    print("")
    print("How may I help you?")
    print("")
    query = input("Question: ")
print("Bye!")
